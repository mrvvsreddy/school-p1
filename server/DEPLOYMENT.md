# Render.com Deployment Guide ğŸš€

## ğŸ“‹ Prerequisites

- GitHub account
- Render.com account (free tier available)
- Supabase project with database

---

## ğŸ”§ Configuration

### 1. Environment Variables

Set these in Render.com dashboard:

```env
# Required
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
DATABASE_URL=postgresql://postgres:[PASSWORD]@[HOST]/postgres

# CORS - Add your frontend URLs (comma-separated)
ALLOWED_ORIGINS=https://your-frontend.vercel.app,https://www.yourdomain.com

# JWT Secret (auto-generated by Render or set manually)
JWT_SECRET_KEY=your-super-secret-key-here
```

---

## ğŸš€ Deployment Steps

### Option 1: Automatic Deployment (Recommended)

1. **Push to GitHub**
   ```bash
   git add .
   git commit -m "Deploy to Render"
   git push origin main
   ```

2. **Connect to Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" â†’ "Web Service"
   - Connect your GitHub repository
   - Render will auto-detect `render.yaml`

3. **Set Environment Variables**
   - In Render dashboard, go to "Environment"
   - Add all required variables listed above
   - Click "Save Changes"

4. **Deploy**
   - Render will automatically build and deploy
   - Build command: `cd server && ./build.sh`
   - Start command: `cd server && ./start.sh`

### Option 2: Manual Configuration

1. **Create New Web Service**
   - Name: `school-backend`
   - Environment: `Python 3`
   - Region: Choose closest to your users

2. **Build & Start Commands**
   ```bash
   # Build Command
   cd server && pip install -r requirements.txt

   # Start Command
   cd server && uvicorn server:app --host 0.0.0.0 --port $PORT
   ```

3. **Environment Variables**
   - Add all variables from above
   - Make sure `PORT` is set by Render automatically

4. **Health Check**
   - Path: `/health`
   - This ensures your service is running

---

## ğŸ”’ Security Checklist

Before deploying to production:

- [ ] Set strong `JWT_SECRET_KEY` (not the default)
- [ ] Update `ALLOWED_ORIGINS` with your actual frontend URL
- [ ] Verify `DATABASE_URL` is correct
- [ ] Enable `secure=True` for cookies in production
- [ ] Set up HTTPS (Render provides this automatically)
- [ ] Review and remove development-only code

---

## ğŸ“ Update Cookie Security for Production

In `server/admin/auth_routes.py`, update the login route:

```python
# Change this line:
secure=False,  # Set to True in production with HTTPS

# To:
secure=True,  # HTTPS only
```

---

## ğŸ§ª Testing Deployment

### 1. Check Health Endpoint
```bash
curl https://your-app.onrender.com/health
```

Expected response:
```json
{"status": "healthy"}
```

### 2. Test Login
```bash
curl -X POST https://your-app.onrender.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@school.edu"}' \
  -c cookies.txt
```

### 3. Test Protected Route
```bash
curl https://your-app.onrender.com/api/auth/me \
  -b cookies.txt
```

---

## ğŸŒ CORS Configuration

### Single Origin
```env
ALLOWED_ORIGINS=https://your-frontend.vercel.app
```

### Multiple Origins
```env
ALLOWED_ORIGINS=https://your-frontend.vercel.app,https://www.yourdomain.com,http://localhost:3000
```

### Development + Production
```env
ALLOWED_ORIGINS=http://localhost:3000,https://your-frontend.vercel.app
```

---

## ğŸ“Š Monitoring

### Render Dashboard
- View logs in real-time
- Monitor CPU/Memory usage
- Check deployment history
- View health check status

### Logs
```bash
# View recent logs
render logs -t school-backend

# Follow logs in real-time
render logs -f school-backend
```

---

## ğŸ”„ Updating Deployment

### Automatic Updates
- Push to GitHub main branch
- Render auto-deploys on push

### Manual Deploy
- Go to Render dashboard
- Click "Manual Deploy" â†’ "Deploy latest commit"

---

## ğŸ› Troubleshooting

### Build Fails
- Check `requirements.txt` is complete
- Verify Python version (3.10+)
- Check build logs in Render dashboard

### App Crashes on Start
- Verify environment variables are set
- Check `DATABASE_URL` format
- Review start command logs

### CORS Errors
- Verify `ALLOWED_ORIGINS` includes your frontend URL
- Check for trailing slashes
- Ensure protocol (http/https) matches

### Cookie Not Working
- Ensure `secure=True` in production
- Verify HTTPS is enabled
- Check `SameSite` settings

---

## ğŸ“ File Structure

```
server/
â”œâ”€â”€ server.py              # Main FastAPI app
â”œâ”€â”€ requirements.txt       # Python dependencies
â”œâ”€â”€ build.sh              # Render build script
â”œâ”€â”€ start.sh              # Render start script
â”œâ”€â”€ .env                  # Local environment (gitignored)
â”œâ”€â”€ env_example.txt       # Environment template
â”œâ”€â”€ admin/                # Admin module
â”‚   â”œâ”€â”€ routes.py
â”‚   â”œâ”€â”€ auth_routes.py
â”‚   â”œâ”€â”€ auth_utils.py
â”‚   â””â”€â”€ schema.py
â””â”€â”€ scripts/              # Setup scripts
    â””â”€â”€ setup_admin_tables.py
```

---

## âœ… Deployment Checklist

- [ ] Code pushed to GitHub
- [ ] Render service created
- [ ] Environment variables configured
- [ ] `ALLOWED_ORIGINS` set correctly
- [ ] `JWT_SECRET_KEY` is strong and unique
- [ ] Database tables created
- [ ] Health check passing
- [ ] Login tested
- [ ] Admin routes accessible
- [ ] CORS working with frontend
- [ ] Cookies working correctly

---

## ğŸ‰ Success!

Your backend is now deployed on Render!

**Backend URL**: `https://your-app.onrender.com`

**Next Steps**:
1. Update frontend `NEXT_PUBLIC_API_URL` to your Render URL
2. Test all API endpoints
3. Configure custom domain (optional)
4. Set up monitoring and alerts

---

## ğŸ“ Support

- [Render Documentation](https://render.com/docs)
- [FastAPI Documentation](https://fastapi.tiangolo.com)
- Check server logs for errors
- Review Render dashboard metrics
